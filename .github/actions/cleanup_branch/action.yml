name: "Cleanup branch"
description: 'Cleanup the UAT environment resources after a branch is merged into main'
inputs:
  kube-cert:
    description: "Kubernetes cluster authentication certificate"
    required: true
  kube-token:
    description: "Kubernetes cluster authentication token"
    required: true
  kube-cluster:
    description: "Kubernetes cluster name"
    required: true
  kube-namespace:
    description: "Kubernetes cluster namespace"
    required: true

runs:
  using: "composite"
  steps:

    - name: Get release name
      id: extract_release_name
      uses: ./.github/actions/get_release_name

    - name: Authenticate to the cluster
      uses: ministryofjustice/laa-reusable-github-actions/.github/actions/authenticate_to_cluster@2aa2676c3cd9876ec7037ee8b3d729d0306cb7c6
      with:
        kube-cert: ${{ inputs.kube-cert }}
        kube-token: ${{ inputs.kube-token }}
        kube-cluster: ${{ inputs.kube-cluster }}
        kube-namespace: ${{ inputs.kube-namespace }}

    - name: Delete preview release
      shell: bash
      env:
        RELEASE_NAME: ${{ steps.extract_release_name.outputs.release-name }}
        KUBE_NAMESPACE: ${{ inputs.kube-namespace }}
      run: helm uninstall "$RELEASE_NAME" --namespace "$KUBE_NAMESPACE"

    - name: Delete preview release's redis instance
      shell: bash
      env:
        RELEASE_NAME: ${{ steps.extract_release_name.outputs.release-name }}
        KUBE_NAMESPACE: ${{ inputs.kube-namespace }}
      run: helm uninstall "${RELEASE_NAME}-redis" --namespace "$KUBE_NAMESPACE"

    - name: Delete preview release's oidc mock
      shell: bash
      env:
        RELEASE_NAME: ${{ steps.extract_release_name.outputs.release-name }}
        KUBE_NAMESPACE: ${{ inputs.kube-namespace }}
      run: helm uninstall "${RELEASE_NAME}-oidc-mock" --namespace "$KUBE_NAMESPACE"

    - name: Delete preview release's redis pvc (persistent volume claim)
      shell: bash
      env:
        RELEASE_NAME: ${{ steps.extract_release_name.outputs.release-name }}
        KUBE_NAMESPACE: ${{ inputs.kube-namespace }}
      run: kubectl delete pvc -l app.kubernetes.io/instance="${RELEASE_NAME}-redis" --namespace "$KUBE_NAMESPACE"

    - name: Delete Helm release history secrets
      shell: bash
      env:
        RELEASE_NAME: ${{ steps.extract_release_name.outputs.release-name }}
        KUBE_NAMESPACE: ${{ inputs.kube-namespace }}
      run: |
        kubectl delete secret -l "name=${RELEASE_NAME},owner=helm" --namespace "$KUBE_NAMESPACE" --ignore-not-found=true
        kubectl delete secret -l "name=${RELEASE_NAME}-redis,owner=helm" --namespace "$KUBE_NAMESPACE" --ignore-not-found=true
        kubectl delete secret -l "name=${RELEASE_NAME}-oidc-mock,owner=helm" --namespace "$KUBE_NAMESPACE" --ignore-not-found=true
