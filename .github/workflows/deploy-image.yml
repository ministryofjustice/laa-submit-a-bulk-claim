name: Build runner image

on:
  push:

permissions:
  id-token: write
  contents: write

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GHCR
        run: |
          echo "${{ github.token }}" | docker login ghcr.io \
            -u ${{ github.actor }} --password-stdin

      - name: Generate inline Dockerfile-runner
        run: |
          cat << 'EOF' > Dockerfile-runner
          FROM ubuntu:22.04
  
          ARG RUNNER_VERSION=2.319.1
          
          USER root
          
          # OS dependencies
          RUN apt-get update && \
              apt-get install -y --no-install-recommends \
                  curl jq tar git sudo ca-certificates \
                  build-essential gnupg xz-utils && \
              rm -rf /var/lib/apt/lists/*
          
          # Install Node.js 20 from official binary
          RUN curl -fsSL https://nodejs.org/dist/v20.11.0/node-v20.11.0-linux-x64.tar.xz -o node.tar.xz && \
              tar -xf node.tar.xz && \
              rm node.tar.xz && \
              mv node-v20.11.0-linux-x64 /usr/local/node && \
              ln -s /usr/local/node/bin/node /usr/bin/node && \
              ln -s /usr/local/node/bin/npm /usr/bin/npm && \
              ln -s /usr/local/node/bin/npx /usr/bin/npx
  
          # Install GitHub Actions runner
          WORKDIR /home/runner
          RUN curl -sL \
                https://github.com/actions/runner/releases/download/v${RUNNER_VERSION}/actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz \
                -o actions-runner.tar.gz && \
              tar xzf actions-runner.tar.gz && \
              rm actions-runner.tar.gz
          
          RUN ./bin/installdependencies.sh
          
          # Create runner user
          RUN useradd -m -u 1001 runner && \
              chown -R runner:runner /home/runner && \
              echo "runner ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
          
          # Install Playwright Browsers
          RUN npm install -g playwright@1.56.1
          
          RUN /usr/local/node/bin/playwright install --with-deps
          
          # Copy browsers to non-root user home
          RUN mkdir -p /home/runner/.cache/ms-playwright && \
              if [ -d /root/.cache/ms-playwright ]; then \
                  cp -r /root/.cache/ms-playwright/* /home/runner/.cache/ms-playwright/; \
              fi && \
              chown -R runner:runner /home/runner/.cache
              
          USER runner
          WORKDIR /home/runner
          
          ENV RUNNER_ALLOW_RUNASROOT=0
          EOF

      - name: Configure aws credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ECR_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.ECR_REGION }}

      - name: Login ecr
        uses: aws-actions/amazon-ecr-login@v2
        id: login-ecr

      - name: Tag and push image
        run: |
          IMAGE="${{ steps.login-ecr.outputs.registry }}/${{ vars.ECR_REPOSITORY }}:github-runner-7"
          echo "Building image: $IMAGE"
          docker build -f Dockerfile-runner -t $IMAGE .

          echo "Pushing image..."
          docker push $IMAGE

          echo "Pushed to ECR: $IMAGE"
